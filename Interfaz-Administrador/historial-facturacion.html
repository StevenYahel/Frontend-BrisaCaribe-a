<!DOCTYPE html>
<html lang="es">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Historial de FacturaciÃ³n</title>

<!-- ICONOS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ------------------ ESTILO GENERAL ------------------ */
body {
    font-family: 'Segoe UI', Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f4f6f9;
    color: #333;
}

h2 {
    margin: 20px 0;
    font-size: 28px;
    text-align: center;
    color: #20242c;
    font-weight: 700;
}

/* ------------------ CONTENEDOR ------------------ */
.container {
    width: 95%;
    margin: 0 auto;
    background: white;
    padding: 22px;
    border-radius: 14px;
    box-shadow: 0 2px 9px rgba(0,0,0,0.12);
}

/* ------------------ TARJETAS DE RESUMEN ------------------ */
.dashboard {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
    flex-wrap: wrap;
}

.card-mini {
    flex: 1;
    min-width: 220px;
    background: white;
    padding: 18px;
    border-radius: 14px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    text-align: center;
}

.card-mini h3 {
    font-size: 18px;
    color: #475569;
}

.card-mini p {
    font-size: 26px;
    color: #0f172a;
    font-weight: bold;
    margin-top: 10px;
}

/* ------------------ FILTROS ------------------ */
.filtros {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 15px;
}

.filtros div {
    flex: 1;
    min-width: 150px;
}

label {
    font-size: 13px;
    font-weight: bold;
}

input, select {
    width: 100%;
    margin-top: 5px;
    padding: 8px 10px;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    background: #fafafa;
}

/* BOTONES */
.btn {
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    color: white;
    transition: 0.3s;
}

 .btn-back {
            display: inline-block;
            margin-bottom: 20px;
            background-color: #2c3e50;
            color: white;
            padding: 10px 18px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            transition: 0.3s ease;
        }

.btn:hover { opacity: 0.9; }

.btn-aplicar { background: #007bff; }
.btn-reset { background: #6c757d; }
.btn-export { background: #28a745; }

/* ------------------ TABLA ------------------ */
.tabla {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.tabla thead {
    background: #20242c;
    color: white;
}

.tabla th, .tabla td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e1e1e1;
}

.tabla tr:hover {
    background: #eef3ff;
}

/* ------------------ ESTADOS ------------------ */
.badge {
    padding: 5px 10px;
    border-radius: 20px;
    color: white;
    font-size: 12px;
}

.badge.pagado { background: #28a745; }
.badge.pendiente { background: #dc3545; }

/* ------------------ PAGINACIÃ“N ------------------ */
.paginador {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 10px;
}

.page-btn {
    padding: 8px 13px;
    border: none;
    background: #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: .3s;
}

.page-btn:hover { background: #ccc; }

.page-btn.active {
    background: #007bff;
    color: white;
}

/* ------------------ MODO MÃ“VIL ------------------ */
.cards { display: none; }

.card {
    background: #fff;
    padding: 16px;
    border-radius: 10px;
    margin-bottom: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,.07);
}

@media (max-width: 880px) {
    table { display: none; }
    .cards { display: block; }
}
</style>
</head>

<body>

<h2>ðŸ“„ Historial de FacturaciÃ³n</h2>

<div class="container">

    <a href="dashboard-admin.html" class="btn-back">â¬… Volver al Dashboard</a>

    
    <!-- DASHBOARD -->
    <div class="dashboard">
        <div class="card-mini">
            <h3>ðŸ’° Ingresos Totales</h3>
            <p id="total-ingresos">$0</p>
        </div>

        <div class="card-mini">
            <h3>ðŸ§¾ Total Facturas</h3>
            <p id="total-facturas">0</p>
        </div>

        <div class="card-mini">
            <h3>ðŸ“† Ãšltimo Ingreso</h3>
            <p id="ultimo-ingreso">$0</p>
        </div>
    </div>

    <!-- GRÃFICA -->
    <div style="
        background: white; 
        padding: 25px; 
        border-radius: 16px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        margin-bottom: 30px;">
        
        <h2 style="margin-bottom: 20px; color: #1e293b;">
            GrÃ¡fica de Ingresos
        </h2>

        <canvas id="ingresosChart" height="100"></canvas>
    </div>

    <!-- FILTROS -->
    <div class="filtros">
        <div>
            <label>Fecha Inicio</label>
            <input type="date" id="filtro-inicio">
        </div>

        <div>
            <label>Fecha Fin</label>
            <input type="date" id="filtro-fin">
        </div>

        <div>
            <label>MÃ©todo</label>
            <select id="filtro-metodo">
                <option value="">Todos</option>
                <option value="Efectivo">Efectivo</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Nequi">Nequi</option>
                <option value="Daviplata">Daviplata</option>
            </select>
        </div>

        <div>
            <label>Estado</label>
            <select id="filtro-estado">
                <option value="">Todos</option>
                <option value="Pagado">Pagado</option>
                <option value="Pendiente">Pendiente</option>
            </select>
        </div>

        <div>
            <label>Buscar</label>
            <input type="text" id="buscador" placeholder="Buscar...">
        </div>
    </div>

    <!-- BOTONES -->
    <div style="margin: 10px 0; display:flex; gap:10px;">
        <button class="btn btn-aplicar" onclick="applyFilters()">Aplicar</button>
        <button class="btn btn-reset" onclick="resetFilters()">Limpiar</button>
        <button class="btn btn-export" onclick="exportCSV()">CSV</button>
        <button class="btn btn-export" onclick="exportPDF()">PDF</button>
    </div>

    <!-- TABLA -->
    <table class="tabla" id="tabla">
        <thead>
            <tr>
                <th># Factura</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>MÃ©todo</th>
                <th>Total</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody id="tabla-body"></tbody>
    </table>

    <!-- CARDS -->
    <div class="cards" id="cards"></div>

    <!-- PAGINACIÃ“N -->
    <div class="paginador" id="paginador"></div>

</div>

<!-- ===========================
     SCRIPTS GENERALES DEL SISTEMA
     =========================== -->
<script>
let facturas = [];
let filtradas = [];
let page = 1;
let pageSize = 6;

async function cargarFacturas() {
    try {
        const response = await fetch("http://127.0.0.1:8000/api/historial-facturas/");
        const data = await response.json();

        facturas = data.map(item => ({
            numero: item.factura_id,
            fecha: item.fecha_pago.split("T")[0],
            cliente: "Mesa " + item.mesa,
            metodo: item.metodo_pago.charAt(0).toUpperCase() + item.metodo_pago.slice(1),
            total: item.monto_pagado,
            estado: "Pagado"
        }));

        filtradas = [...facturas];
        actualizarDashboard();
        generarGrafica(data);
        render();

    } catch (error) {
        console.error("Error cargando facturas:", error);
    }
}

/* ------------------ DASHBOARD ------------------ */
function actualizarDashboard() {
    const total = facturas.reduce((sum, f) => sum + f.total, 0);
    const ultimo = facturas.length > 0 ? facturas[facturas.length - 1].total : 0;

    document.getElementById("total-ingresos").innerText = "$" + total.toLocaleString();
    document.getElementById("total-facturas").innerText = facturas.length;
    document.getElementById("ultimo-ingreso").innerText = "$" + ultimo.toLocaleString();
}

/* ------------------ GRAFICA CHART.JS ------------------ */
function generarGrafica(data) {

    data.sort((a, b) => new Date(a.fecha_pago) - new Date(b.fecha_pago));

    const fechas = data.map(item => {
        const fecha = new Date(item.fecha_pago);
        return fecha.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
    });

    const montos = data.map(item => item.monto_pagado);

    const ctx = document.getElementById('ingresosChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: fechas,
            datasets: [{
                label: 'Ingresos ($ COP)',
                data: montos,
                tension: 0.35,
                borderWidth: 3,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.22)',
                pointBackgroundColor: '#1d4ed8',
                pointRadius: 4,
                pointHoverRadius: 7,
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

/* ------------------ RENDER GENERAL ------------------ */
function render() {
    const inicio = (page - 1) * pageSize;
    const pageData = filtradas.slice(inicio, inicio + pageSize);

    const tbody = document.getElementById("tabla-body");
    tbody.innerHTML = "";

    pageData.forEach(f => {
        tbody.innerHTML += `
        <tr>
            <td>${f.numero}</td>
            <td>${f.fecha}</td>
            <td>${f.cliente}</td>
            <td>${f.metodo}</td>
            <td>$${f.total.toLocaleString()}</td>
            <td><span class="badge pagado">${f.estado}</span></td>
        </tr>`;
    });

    const cards = document.getElementById("cards");
    cards.innerHTML = "";

    pageData.forEach(f => {
        cards.innerHTML += `
        <div class="card">
            <h3>#${f.numero}</h3>
            <p><b>Fecha:</b> ${f.fecha}</p>
            <p><b>Cliente:</b> ${f.cliente}</p>
            <p><b>MÃ©todo:</b> ${f.metodo}</p>
            <p><b>Total:</b> $${f.total.toLocaleString()}</p>
            <span class="badge pagado">${f.estado}</span>
        </div>`;
    });

    const pages = Math.ceil(filtradas.length / pageSize);
    const paginador = document.getElementById("paginador");
    paginador.innerHTML = "";

    for (let i = 1; i <= pages; i++) {
        paginador.innerHTML += `
            <button class="page-btn ${i === page ? 'active' : ''}"
                onclick="page=${i}; render();">${i}</button>`;
    }
}

/* ------------------ FILTROS ------------------ */
function applyFilters() {

    const fi = document.getElementById("filtro-inicio").value;
    const ff = document.getElementById("filtro-fin").value;
    const metodo = document.getElementById("filtro-metodo").value;
    const estado = document.getElementById("filtro-estado").value;
    const busq = document.getElementById("buscador").value.toLowerCase();

    filtradas = facturas.filter(f => {

        if (fi && f.fecha < fi) return false;
        if (ff && f.fecha > ff) return false;
        if (metodo && f.metodo !== metodo) return false;
        if (estado && f.estado !== estado) return false;

        if (busq) {
            const texto = `${f.numero} ${f.cliente} ${f.metodo}`.toLowerCase();
            if (!texto.includes(busq)) return false;
        }

        return true;
    });

    page = 1;
    render();
}

function resetFilters() {
    document.getElementById("filtro-inicio").value = "";
    document.getElementById("filtro-fin").value = "";
    document.getElementById("filtro-metodo").value = "";
    document.getElementById("filtro-estado").value = "";
    document.getElementById("buscador").value = "";

    filtradas = [...facturas];
    page = 1;
    render();
}

/* ------------------ EXPORT CSV ------------------ */
function exportCSV() {
    let csv = "Numero,Fecha,Cliente,Metodo,Total,Estado\n";

    filtradas.forEach(f => {
        csv += `${f.numero},${f.fecha},${f.cliente},${f.metodo},${f.total},${f.estado}\n`;
    });

    const blob = new Blob([csv], {type: "text/csv"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "historial_facturacion.csv";
    a.click();
}

/* ------------------ EXPORT PDF ------------------ */
function exportPDF() {

    const { jsPDF } = window.jspdf;

    const doc = new jsPDF("p","pt","a4");
    doc.setFontSize(16);
    doc.text("Historial de FacturaciÃ³n", 40, 40);

    const tabla = filtradas.map(f => [
        f.numero, f.fecha, f.cliente, f.metodo,
        `$${f.total.toLocaleString()}`, f.estado
    ]);

    doc.autoTable({
        startY: 70,
        head: [["#", "Fecha", "Cliente", "MÃ©todo", "Total", "Estado"]],
        body: tabla
    });

    doc.save("facturas.pdf");
}

cargarFacturas();
</script>

</body>
</html>
